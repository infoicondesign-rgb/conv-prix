<!DOCTYPE html>
<html lang="fr-CA">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Conversion & Prix</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="logo-192.png">
<style>
  :root{--bg:#f8fafc; --card:#ffffff; --muted:#475569; --text:#0f172a; --border:#e2e8f0; --acc:#2563eb;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.98),rgba(255,255,255,.94));border-bottom:1px solid var(--border)}
  .wrap{max-width:1000px;margin:0 auto;padding:12px}
  .brand{display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center}
  .brand img{height:42px;width:auto}
  .brand h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
  .btn{background:#ffffff;border:1px solid var(--border);padding:8px 12px;border-radius:10px;font-weight:600}
  table{width:100%;border-collapse:collapse;font-size:15px;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left}
  thead th{position:sticky;top:112px;background:var(--card);z-index:9}
  input[type=number]{width:100%;background:#ffffff;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:16px}
  input[type=number]:focus{outline:2px solid var(--acc); outline-offset:1px}
  .num{text-align:right;white-space:nowrap}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .field{flex:1 1 220px;display:flex;flex-direction:column;gap:6px}
  .totals{display:flex;gap:24px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .big{font-size:22px;font-weight:800}
  .sticky{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(255,255,255,.98),rgba(255,255,255,.94));border-top:1px solid var(--border);
          padding:12px 12px calc(12px + env(safe-area-inset-bottom)); box-shadow: 0 -8px 20px rgba(15,23,42,.06);}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img src="data:image/png;base64,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" alt="Logo">
      <h1>Tableau de conversion prix</h1>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnReset">Réinitialiser</button>
      <button class="btn" id="btnShare">Partager / Imprimer</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-bottom:140px;">
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Longueur</th>
          <th>Largeur</th>
          <th class="num">Pied²</th>
          <th>Type</th>
          <th class="num">Taux</th>
          <th class="num">Taux cost</th>
          <th class="num">Coût</th>
          <th class="num">Prix</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="card">
    <div class="row">
      <div class="field">
        <label>Minutes — @ 100$/h</label>
        <input id="b26" type="number" inputmode="decimal" step="1" placeholder="0">
      </div>
      <div class="field">
        <label>Heures — @ 100$/h</label>
        <input id="b28" type="number" inputmode="decimal" step="0.25" placeholder="0">
      </div>
    </div>
    <div class="row">
      <div class="field"><label class="muted">Prix minutes</label><input id="d26" type="number" readonly></div>
      <div class="field"><label class="muted">Prix heures</label><input id="d28" type="number" readonly></div>
    </div>
  </div>
</main>

<div class="sticky">
  <div class="wrap">
    <div class="totals">
      <div><span class="muted">Total coût</span><br><span id="h26" class="big">—</span></div>
      <div><span class="muted">Total prix</span><br><span id="i26" class="big">—</span></div>
    </div>
  </div>
</div>

<script>
(function(){
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){ navigator.serviceWorker.register('./sw.js'); });
  }

  const RESET_MINUTES = 15; // durée d'inactivité avant reset
  let lastActive = Date.now();

  const data = {"rows": [{"type": "Pare-pierre 30''", "mode": "area", "largeur_default": 30.0, "taux": 11.0, "taux_cost": 5.25}, {"type": "Pare-pierre 60''", "mode": "area", "largeur_default": 60.0, "taux": 15.0, "taux_cost": 5.06}, {"type": "Murale", "mode": "area", "largeur_default": 0.0, "taux": 6.95, "taux_cost": 1.53}, {"type": "Découpe", "mode": "area", "largeur_default": 0.0, "taux": 5.95, "taux_cost": 0.54}, {"type": "WRAP 3M", "mode": "area", "largeur_default": 0.0, "taux": 40.0, "taux_cost": 13.33}, {"type": "WRAP HEXIS", "mode": "area", "largeur_default": 0.0, "taux": 40.0, "taux_cost": 13.33}, {"type": "WRAP Carbon", "mode": "area", "largeur_default": 0.0, "taux": 80.0, "taux_cost": 30.0}, {"type": "STD / LAM STD", "mode": "area", "largeur_default": 0.0, "taux": 7.65, "taux_cost": 1.0}, {"type": "STD / LAM WRAP", "mode": "area", "largeur_default": 0.0, "taux": 8.5, "taux_cost": 1.51}, {"type": "WRAP / LAM", "mode": "area", "largeur_default": 0.0, "taux": 11.0, "taux_cost": 2.18}, {"type": "PROMO LAM", "mode": "area", "largeur_default": 0.0, "taux": 6.95, "taux_cost": 0.75}, {"type": "PROMO / NONLAM", "mode": "area", "largeur_default": 0.0, "taux": 5.0, "taux_cost": 0.9}, {"type": "Reflec", "mode": "area", "largeur_default": 0.0, "taux": 9.95, "taux_cost": 2.62}, {"type": "Magnétique", "mode": "area", "largeur_default": 0.0, "taux": 20.0, "taux_cost": 1.5}, {"type": "Givré", "mode": "area", "largeur_default": 0.0, "taux": 6.95, "taux_cost": 1.15}, {"type": "Contre-vision", "mode": "area", "largeur_default": 0.0, "taux": 9.95, "taux_cost": 0.71}, {"type": "Découpe Gris CHK", "mode": "area", "largeur_default": 0.0, "taux": 9.95, "taux_cost": 2.57}, {"type": "Bannière", "mode": "area", "largeur_default": 0.0, "taux": 6.95, "taux_cost": 0.17}, {"type": "Aluco", "mode": "area", "largeur_default": 0.0, "taux": 3.25, "taux_cost": 1.88}, {"type": "Coro", "mode": "area", "largeur_default": 0.0, "taux": 2.0, "taux_cost": 0.45}], "config": {"labor_min_rate_price": 100.0, "labor_min_rate_cost": 40.0, "labor_hr_rate_price": 100.0, "labor_hr_rate_cost": 40.0}};
  const fmtCAD = new Intl.NumberFormat('fr-CA', {style:'currency', currency:'CAD'});
  function num(v){ if(v===null||v===undefined||v==='') return 0; v=(''+v).replace(',','.'); var n=parseFloat(v); return isNaN(n)?0:n; }

  function makeRow(r){
    var tr = document.createElement('tr');
    tr.dataset.idx = r;
    var row = data.rows[r];
    tr.innerHTML = ''
      + '<td><input type="number" step="0.1" placeholder="0" class="b"></td>'
      + '<td><input type="number" step="0.1" placeholder="0" class="c"></td>'
      + '<td class="num d">0</td>'
      + '<td>'+row.type+(row.mode==='linear'?' <span class="muted">(linéaire)</span>':'')+'</td>'
      + '<td class="num f">'+row.taux.toFixed(2)+'</td>'
      + '<td class="num g">'+row.taux_cost.toFixed(2)+'</td>'
      + '<td class="num h">0</td>'
      + '<td class="num i">0</td>';
    var b = tr.querySelector('.b');
    var c = tr.querySelector('.c');
    if (row.largeur_default) c.value = row.largeur_default;
    b.addEventListener('input', onActivity);
    c.addEventListener('input', onActivity);
    b.addEventListener('input', recalc);
    c.addEventListener('input', recalc);
    return tr;
  }

  function recalc(){
    var sumH=0, sumI=0;
    document.querySelectorAll('#tbody tr').forEach(function(tr){
      var idx = parseInt(tr.dataset.idx);
      var row = data.rows[idx];
      var b = num(tr.querySelector('.b').value);
      var c = num(tr.querySelector('.c').value);
      var d = (row.mode==='linear') ? b : (b*c)/144.0;
      var f = row.taux, g = row.taux_cost;
      var h = d*g;
      var i = (row.mode==='linear') ? (b*f) : (d*f);
      tr.querySelector('.d').textContent = d.toFixed(2);
      tr.querySelector('.h').textContent = fmtCAD.format(h);
      tr.querySelector('.i').textContent = fmtCAD.format(i);
      sumH += h; sumI += i;
    });
    var b26 = num(document.getElementById('b26').value);
    var b28 = num(document.getElementById('b28').value);
    var d26 = (b26/60.0)*100.0;
    var d28 = (b28)*100.0;
    document.getElementById('d26').value = d26.toFixed(2);
    document.getElementById('d28').value = d28.toFixed(2);
    var h26 = sumH + (b26/60.0)*40.0 + b28*40.0;
    var i26 = sumI + d26 + d28;
    document.getElementById('h26').textContent = fmtCAD.format(h26);
    document.getElementById('i26').textContent = fmtCAD.format(i26);
    try{ localStorage.setItem('conv_prix_state', JSON.stringify(serialize())); }catch(e){}
  }

  function serialize(){
    var rows = Array.prototype.slice.call(document.querySelectorAll('#tbody tr')).map(function(tr){
      return { b: tr.querySelector('.b').value, c: tr.querySelector('.c').value };
    });
    return { items: rows, b26: document.getElementById('b26').value, b28: document.getElementById('b28').value };
  }
  function deserialize(d){
    if(!d) return;
    var trs = document.querySelectorAll('#tbody tr');
    (d.items||[]).forEach(function(v,i){
      if(trs[i]){ trs[i].querySelector('.b').value = v.b||''; trs[i].querySelector('.c').value = v.c||''; }
    });
    document.getElementById('b26').value = d.b26||'';
    document.getElementById('b28').value = d.b28||'';
  }

  function resetAll(){ 
    try{ localStorage.removeItem('conv_prix_state'); }catch(e){}
    document.querySelectorAll('#tbody tr').forEach(function(tr){
      var idx = parseInt(tr.dataset.idx);
      var row = data.rows[idx];
      tr.querySelector('.b').value = '';
      tr.querySelector('.c').value = row.largeur_default || '';
      tr.querySelector('.d').textContent = '0';
      tr.querySelector('.h').textContent = fmtCAD.format(0);
      tr.querySelector('.i').textContent = fmtCAD.format(0);
    });
    document.getElementById('b26').value = '';
    document.getElementById('b28').value = '';
    document.getElementById('d26').value = '0.00';
    document.getElementById('d28').value = '0.00';
    document.getElementById('h26').textContent = fmtCAD.format(0);
    document.getElementById('i26').textContent = fmtCAD.format(0);
    recalc();
  }

  function onActivity(){ lastActive = Date.now(); }
  ['touchstart','pointerdown','mousemove','keydown','scroll'].forEach(function(ev){
    window.addEventListener(ev, onActivity, {passive:true});
  });
  document.getElementById('b26').addEventListener('input', function(){ onActivity(); recalc(); });
  document.getElementById('b28').addEventListener('input', function(){ onActivity(); recalc(); });
  document.getElementById('btnReset').addEventListener('click', function(){ if(confirm('Réinitialiser et effacer les saisies ?')) resetAll(); });
  document.getElementById('btnShare').addEventListener('click', function(){ window.print(); });

  setInterval(function(){ 
    var ms = Date.now() - lastActive;
    if (ms > RESET_MINUTES*60*1000) { resetAll(); lastActive = Date.now(); }
  }, 30000);

  (function init(){ 
    var tbody = document.getElementById('tbody');
    data.rows.forEach(function(_,i){ tbody.appendChild(makeRow(i)); });
    var saved = localStorage.getItem('conv_prix_state');
    if(saved) try{ deserialize(JSON.parse(saved)); }catch(e){}
    recalc();
  })();
})();
</script>
</body>
</html>
